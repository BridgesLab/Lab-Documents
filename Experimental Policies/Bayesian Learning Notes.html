<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Dave Bridges">
<meta name="dcterms.date" content="2025-12-13">

<title>Notes while learning Bayesian inference</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="Bayesian Learning Notes_files/libs/clipboard/clipboard.min.js"></script>
<script src="Bayesian Learning Notes_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="Bayesian Learning Notes_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="Bayesian Learning Notes_files/libs/quarto-html/popper.min.js"></script>
<script src="Bayesian Learning Notes_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Bayesian Learning Notes_files/libs/quarto-html/anchor.min.js"></script>
<link href="Bayesian Learning Notes_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Bayesian Learning Notes_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Bayesian Learning Notes_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Bayesian Learning Notes_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Bayesian Learning Notes_files/libs/bootstrap/bootstrap-ff7067f47e26017551bec3c0280d8ab3.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#purpose" id="toc-purpose" class="nav-link active" data-scroll-target="#purpose">Purpose</a>
  <ul class="collapse">
  <li><a href="#single-parameter-models" id="toc-single-parameter-models" class="nav-link" data-scroll-target="#single-parameter-models">Single Parameter Models</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  <li><a href="#session-information" id="toc-session-information" class="nav-link" data-scroll-target="#session-information">Session Information</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Notes while learning Bayesian inference</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Dave Bridges </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 13, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># hide this code chunk</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># defines the se function</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>se <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sd</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">length</span>(x))</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">#load these packages, nearly always needed</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># sets maize and blue color scheme</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>color_scheme <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#00274c"</span>, <span class="st">"#ffcb05"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="purpose" class="level2">
<h2 class="anchored" data-anchor-id="purpose">Purpose</h2>
<p>These are notes as I work through and understand the notes from BIOSTAT 682</p>
<section id="single-parameter-models" class="level3">
<h3 class="anchored" data-anchor-id="single-parameter-models">Single Parameter Models</h3>
<p>The motivating example here is that there was an incidence of cancer wherein 8 cancers appeared out of a total of 145 people. The question is whether this incidence is greater than the expected incidence of 4.458% from <span class="citation" data-cites="CancerStatisticsNCI2015">(<a href="#ref-CancerStatisticsNCI2015" role="doc-biblioref"><span>“Cancer <span>Statistics</span> - <span>NCI</span>”</span> 2015</a>)</span></p>
<p>Using the binomial distribution probability mass function for a binomial distribution</p>
<p><span class="math display">\[P(Y = y | n, \theta) = \binom{n}{y} \theta^y (1 - \theta)^{n-y}\]</span> In this nomenclature <span class="math inline">\(\binom{n}{y}\)</span> expands out to <span class="math inline">\(\frac{n!}{y! \times (1-y)!}\)</span> where <span class="math inline">\(y\)</span> is the number of successes, <span class="math inline">\(n\)</span> is the number of trials. In the overall cuntion <span class="math inline">\(\theta\)</span> is the probability of success on each trial.</p>
<p>This can also be denoted as <span class="math inline">\(Y \sim \text{Binomial}(n, \theta)\)</span> where <span class="math inline">\(n\)</span> is the number of trials and <span class="math inline">\(\theta\)</span> is the probability of success on each trial, Using this we can calculate the likelihood of observing 8 or more cancers out of 145 people given the expected incidence rate of 4.44% and some other probabilities</p>
<p>The hypothesis being tested are that:</p>
<ul>
<li><span class="math inline">\(H_A: \theta = 0.03\)</span></li>
<li><span class="math inline">\(H_B: \theta = 0.04\)</span></li>
<li><span class="math inline">\(H_C: \theta = 0.05\)</span></li>
<li><span class="math inline">\(H_D: \theta = 0.06\)</span></li>
</ul>
<p>In terms of prior probabilities, we can assign prior probabilities to each of the hypotheses above. If we think that <span class="math inline">\(H1\)</span> is 50% likely, and <span class="math inline">\(H_{A-D}\)</span> are equally likely after that.</p>
<p>Likelihoods are calculated from the probability mass function for the binomal function <span class="math inline">\(Y \sim \text{Binomial}(n, \theta)\)</span></p>
<p>can be calculated for each tested hypothesis (<span class="math inline">\(H_x\)</span> in comparason to all possible hypotheses <span class="math inline">\(Hi\)</span>) via <span class="math inline">\(P(H_x \mid y_o = 8) = \frac{P(H_x) \times, P(y_o = 8 \mid H_x)}{\sum_{i=A}^{D} P(H_i) \times, P(y_o = 8 \mid H_i)}\)</span>. In simplified terms this is the prior probability of the hypothesis, times its likelihood divided by the sum of all prior probabilities times their likelihoods.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">145</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>cases <span class="ot">&lt;-</span> <span class="dv">8</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>theta <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.03</span>, <span class="fl">0.04</span>, <span class="fl">0.05</span>, <span class="fl">0.06</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>priors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fu">rep</span>(<span class="fl">0.5</span><span class="sc">/</span><span class="dv">3</span>,<span class="dv">3</span>))</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">hypothesis =</span> theta,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">priors=</span>priors) <span class="sc">|&gt;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">likelihood =</span> <span class="fu">dbinom</span>(cases, <span class="at">size =</span> n, <span class="at">prob =</span> hypothesis)) <span class="sc">|&gt;</span> <span class="co">#this does not give the same results as the notes probably an approximation</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rel.likelihood =</span> likelihood <span class="sc">/</span> <span class="fu">min</span>(likelihood)) <span class="sc">|&gt;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">posterior =</span> priors <span class="sc">*</span> likelihood <span class="sc">/</span> <span class="fu">sum</span>(priors <span class="sc">*</span> likelihood)) <span class="sc">|&gt;</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption=</span><span class="fu">paste0</span>(<span class="st">"Probability of observing "</span>, cases, <span class="st">" cases out of "</span>,n, <span class="st">" trials"</span>),</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">digits=</span><span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Probability of observing 8 cases out of 145 trials</caption>
<thead>
<tr class="header">
<th style="text-align: right;">hypothesis</th>
<th style="text-align: right;">priors</th>
<th style="text-align: right;">likelihood</th>
<th style="text-align: right;">rel.likelihood</th>
<th style="text-align: right;">posterior</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.03</td>
<td style="text-align: right;">0.500</td>
<td style="text-align: right;">0.04</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">0.244</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.04</td>
<td style="text-align: right;">0.167</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">2.415</td>
<td style="text-align: right;">0.196</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">0.167</td>
<td style="text-align: right;">0.14</td>
<td style="text-align: right;">3.429</td>
<td style="text-align: right;">0.279</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.06</td>
<td style="text-align: right;">0.167</td>
<td style="text-align: right;">0.14</td>
<td style="text-align: right;">3.460</td>
<td style="text-align: right;">0.281</td>
</tr>
</tbody>
</table>
</div>
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#this does not give the same results as the notes</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This means that hypotheses 4 and 5 explain the data approximately the same times better than hypothesis 1.</p>
<section id="the-likilihood-principal" class="level4">
<h4 class="anchored" data-anchor-id="the-likilihood-principal">The likilihood principal</h4>
<p>There is an articulation of the <em>Likelihood Principal</em>: once <span class="math inline">\(Y\)</span> has been observed we now note it as <span class="math inline">\(Y = y_o\)</span> , and no other value of Y matters. We should treat as <span class="math inline">\(L(\theta|y_o) = Pr(Y = y_o | \theta)\)</span> as the only likelihood function of <span class="math inline">\(\theta\)</span> and no other aspects of the experiment or data matter for inference.</p>
</section>
<section id="the-conjugate-prior-for-a-binomial-distribution-is-a-beta-distribution" class="level4">
<h4 class="anchored" data-anchor-id="the-conjugate-prior-for-a-binomial-distribution-is-a-beta-distribution">The conjugate prior for a binomial distribution is a beta distribution</h4>
<p>What if the prior probabilities are continuous, if we model them as <span class="math inline">\(\theta = Beta(\alpha,\beta)\)</span>. The density of this prior is given by:</p>
<p><span class="math display">\[ \pi(\theta \mid \alpha, \beta) = \frac{\Gamma(\alpha + \beta)}{\Gamma(\alpha)\Gamma(\beta)} \theta^{\alpha - 1} (1 - \theta)^{\beta - 1} \]</span></p>
<p>In this case <span class="math inline">\(\frac{\Gamma(\alpha + \beta)}{\Gamma(\alpha)\Gamma(\beta)}\)</span> is a normalizing factor that ensures probabilities intgrate to one and exist between zero and one.</p>
<p>The posterior density is therefore proprotional to to the prior times the likelihood <span class="math inline">\(\pi(\theta \mid y) \propto \pi(\theta) \times p(y \mid \theta)\)</span>. This expands out to this <span class="math inline">\(\pi(\theta \mid y) \propto \theta^{\alpha - 1} (1 - \theta)^{\beta - 1} \times \theta^y (1 - \theta)^{n - y}\)</span> droppping the constants for now. By combining the exponents we get <span class="math inline">\(\pi(\theta \mid y) \propto \theta^{(\alpha + y) - 1} (1 - \theta)^{( \beta + n - y) - 1}\)</span>. This is the kernel (un-normalized density) of a Beta distribution with updated parameters <span class="math inline">\(\alpha' = \alpha + y, \quad \beta' = \beta + n - y\)</span></p>
<p>To get the proper density, we need to insert the Beta normalizing constant with the new parameters <span class="math inline">\(\pi(\theta \mid y) = \frac{\Gamma(\alpha + y + \beta + n - y)}{\Gamma(\alpha + y)\Gamma(\beta + n - y)} \theta^{\alpha + y - 1} (1 - \theta)^{\beta + n - y - 1}\)</span> which simplifies to <span class="math inline">\(\theta \mid y \sim \operatorname{Beta}(y + \alpha, \, n - y + \beta)\)</span>. This is the posterior probability distribution.</p>
<p>To calculate the mean and variance, for any <span class="math inline">\(\operatorname{Beta}(a, b)\)</span> random variable:<span class="math inline">\(\mathbb{E}[\theta] = \frac{a}{a + b}, \quad \operatorname{Var}(\theta) = \frac{ab}{(a + b)^2 (a + b + 1)}\)</span> we can plug in <span class="math inline">\(a = y + \alpha\)</span>, <span class="math inline">\(b = n - y + \beta\)</span>: <span class="math inline">\(\mathbb{E}[\theta \mid y] = \frac{y + \alpha}{n + \alpha + \beta}\)</span> (this is a weighted average between the observed proportion <span class="math inline">\(y/n\)</span> and the prior “pseudo-mean” <span class="math inline">\(\alpha/(\alpha + \beta)\)</span>, with more weight on the data when n is large) <span class="math inline">\(\operatorname{Var}(\theta \mid y) = \frac{(y + \alpha)(n - y + \beta)}{(n + \alpha + \beta)^2 (n + \alpha + \beta + 1)}\)</span></p>
<p>To summarize if our priors are <span class="math inline">\(Beta(\alpha, \beta)\)</span> and our posterior probabilities are <span class="math inline">\(P(\theta|Y=y_o=8)=Beta(y_o + α, n − y_o + β)\)</span></p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#mean = alpha / (alpha + beta) so to guestimate 0.444 is 4/85</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">&lt;-</span>  <span class="dv">1</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>range <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="at">by=</span><span class="fl">0.001</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>prior <span class="ot">&lt;-</span> <span class="fu">dbeta</span>(range,<span class="at">shape1=</span>alpha,<span class="at">shape2=</span>beta)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>posterior <span class="ot">&lt;-</span> <span class="fu">dbeta</span>(range,<span class="at">shape1=</span>cases <span class="sc">+</span> alpha, <span class="at">shape2=</span>n <span class="sc">-</span> cases <span class="sc">+</span> beta)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>data.beta <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">range=</span>range,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>                        <span class="at">prior=</span>prior,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">posterior=</span>posterior) <span class="sc">|&gt;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">c</span>(<span class="st">"prior"</span>,<span class="st">"posterior"</span>),</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to=</span><span class="st">"distribution"</span>,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to=</span><span class="st">"value"</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data.beta,<span class="fu">aes</span>(<span class="at">y=</span>value,<span class="at">x=</span>range,<span class="at">col=</span>distribution)) <span class="sc">+</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title=</span><span class="fu">paste0</span>(<span class="st">"Distribution - Beta("</span>,<span class="fu">round</span>(alpha,<span class="dv">2</span>),<span class="st">","</span>,<span class="fu">round</span>(beta,<span class="dv">2</span>),<span class="st">")"</span>),</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>       <span class="at">x=</span><span class="st">"Value"</span>,</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">y=</span><span class="st">"Likelihood"</span>) <span class="sc">+</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>(<span class="at">base_size=</span><span class="dv">16</span>) <span class="sc">+</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.85</span>,<span class="fl">0.85</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Bayesian-Learning-Notes_files/figure-html/lecture-2-continuous-prior-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#these are defined from the conjugate prior/posterior relationship</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>prior_mean <span class="ot">=</span> alpha<span class="sc">/</span>(alpha<span class="sc">+</span>beta)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>prior_ci_lower <span class="ot">=</span> <span class="fu">qbeta</span>(<span class="fl">0.025</span>, alpha, beta)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>prior_ci_upper <span class="ot">=</span> <span class="fu">qbeta</span>(<span class="fl">0.975</span>, alpha, beta)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>posterior_mean <span class="ot">=</span> (alpha <span class="sc">+</span> cases)<span class="sc">/</span>(alpha<span class="sc">+</span>cases<span class="sc">+</span>n<span class="sc">-</span>cases<span class="sc">+</span>beta)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>posterior_ci_lower <span class="ot">=</span> <span class="fu">qbeta</span>(<span class="fl">0.025</span>, (alpha <span class="sc">+</span> cases), (cases<span class="sc">+</span>n<span class="sc">-</span>cases<span class="sc">+</span>beta))</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>posterior_ci_upper <span class="ot">=</span> <span class="fu">qbeta</span>(<span class="fl">0.975</span>, (alpha <span class="sc">+</span> cases), (cases<span class="sc">+</span>n<span class="sc">-</span>cases<span class="sc">+</span>beta))</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">Distribution=</span><span class="fu">c</span>(<span class="st">"Prior"</span>,<span class="st">"Posterior"</span>),</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">Mean=</span><span class="fu">c</span>(prior_mean,posterior_mean),</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">CI_Lower=</span><span class="fu">c</span>(prior_ci_lower,posterior_ci_lower),</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">CI_Upper=</span><span class="fu">c</span>(prior_ci_upper,posterior_ci_upper)) <span class="sc">|&gt;</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">digits=</span><span class="dv">3</span>,</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">caption=</span><span class="st">"Summary statistics for prior and posterior distributions"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Summary statistics for prior and posterior distributions</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Distribution</th>
<th style="text-align: right;">Mean</th>
<th style="text-align: right;">CI_Lower</th>
<th style="text-align: right;">CI_Upper</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Prior</td>
<td style="text-align: right;">0.500</td>
<td style="text-align: right;">0.025</td>
<td style="text-align: right;">0.975</td>
</tr>
<tr class="even">
<td style="text-align: left;">Posterior</td>
<td style="text-align: right;">0.061</td>
<td style="text-align: right;">0.027</td>
<td style="text-align: right;">0.100</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>By this model the posterior probability that the incidence is greater than 4.44% is 79.8%.</p>
<section id="example-of-beta-as-a-conjugate-prior" class="level5">
<h5 class="anchored" data-anchor-id="example-of-beta-as-a-conjugate-prior">Example of Beta as a Conjugate Prior</h5>
<p>Imagine there is a mouse that has a rare phenotype, we observe <span class="math inline">\(n=20\)</span> mice, and find <span class="math inline">\(y=4\)</span> have this phenotype. The probability of this occuring can be denoted as <span class="math inline">\(Y | p \sim Bin(20,p)\)</span>. Before noticing this, we believe the phenotype is uncommon but i have low certainty on this hypothesis, given as <span class="math inline">\(p \sim Beta(2,20)\)</span>. This was selected because in <span class="math inline">\(Beta(\alpha,\beta)\)</span> this means that</p>
<ul>
<li><span class="math inline">\(\alpha-1\)</span> is how often its observed (successes). By that <span class="math inline">\(\alpha=\text{successes}+1\)</span></li>
<li><span class="math inline">\(\beta-1\)</span> is the number of times not observed (failures). By that <span class="math inline">\(\beta=\text{failures}+1\)</span></li>
<li><span class="math inline">\(\alpha + \beta\)</span> is the strength of this conviction</li>
<li>The mean estimate is <span class="math inline">\(E[p]=\frac{\alpha}{\alpha + \beta}\)</span></li>
</ul>
<p>So this prior is formulating on the expectation that out of 18 examples, I would have expected one example of this phenotype. This corresponds to an estimate of 10% <span class="math inline">\(\frac{2}{2+19}\)</span>. Here are three possible visualizations of priors for this example, presuming one success out of 18, 5, or 30 trials</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>prior.data.frame <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">probability=</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="at">by=</span><span class="fl">0.01</span>)) <span class="sc">|&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(<span class="at">observed=</span><span class="dv">1</span>, <span class="at">attempts=</span><span class="fu">c</span>(<span class="dv">20</span>,<span class="dv">5</span>,<span class="dv">30</span>)) <span class="sc">|&gt;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">alpha =</span> observed <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">beta =</span> attempts <span class="sc">-</span> observed <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prior =</span> <span class="fu">paste0</span>(<span class="st">"Beta("</span>,alpha,<span class="st">","</span>,beta,<span class="st">")"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">density=</span><span class="fu">dbeta</span>(probability,alpha,beta)) </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(prior.data.frame, <span class="fu">aes</span>(<span class="at">y=</span>density,<span class="at">x=</span>probability,<span class="at">col=</span>prior)) <span class="sc">+</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>(<span class="at">base_size =</span> <span class="dv">16</span>) <span class="sc">+</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="fu">c</span>(<span class="fl">0.8</span>,<span class="fl">0.8</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Bayesian-Learning-Notes_files/figure-html/binomial-conjugate-example-prior-plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The posterior is the likelihood times prior is <span class="math inline">\(L(p|y_o=4) \times \pi(p)\)</span>. This becomes <span class="math inline">\((p∣y_o) \sim Beta(\alpha+Y_o,\beta+n−y_o)\)</span>. For this example this computes to <span class="math inline">\(Beta(2+4,20+20-4)=Beta(6,36)\)</span></p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">probability=</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="at">by=</span><span class="fl">0.01</span>)) <span class="sc">|&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prior =</span> <span class="fu">dbeta</span>(probability,<span class="dv">2</span>,<span class="dv">18</span>),</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">posterior =</span> <span class="fu">dbeta</span>(probability,<span class="dv">6</span>,<span class="dv">36</span>)) <span class="sc">|&gt;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">c</span>(prior,posterior),<span class="at">names_to=</span><span class="st">"type"</span>,<span class="at">values_to =</span> <span class="st">"density"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y=</span>density,<span class="at">x=</span>probability,<span class="at">col=</span>type)) <span class="sc">+</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="dv">4</span><span class="sc">/</span><span class="dv">20</span>, <span class="at">lty=</span><span class="dv">2</span>, <span class="at">col=</span><span class="st">"grey"</span>) <span class="sc">+</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">geom  =</span> <span class="st">"text"</span>,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">x     =</span> <span class="dv">4</span><span class="sc">/</span><span class="dv">20</span><span class="fl">+0.01</span>,           <span class="co"># ← your chosen x-position</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">y     =</span> <span class="dv">8</span>,            <span class="co"># ← your chosen y-position</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Observed"</span>,</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="dv">0</span>,            <span class="co"># 0 = left justified (most important part)</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">vjust =</span> <span class="fl">0.5</span>,          <span class="co"># optional: 0.5 = vertically centered</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">size  =</span> <span class="dv">5</span>, <span class="at">color =</span> <span class="st">"grey"</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>(<span class="at">base_size=</span><span class="dv">16</span>) <span class="sc">+</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="fu">c</span>(<span class="fl">0.8</span>,<span class="fl">0.8</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Bayesian-Learning-Notes_files/figure-html/beta-example-prior-posterior-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Given this result of a posterior probability of <span class="math inline">\(Beta(6,36)\)</span> this corresponds to a mean probability of <span class="math inline">\(\frac{6}{6+36}=\frac{6}{42}=\)</span> 0.1428571. The variance is <span class="math inline">\(Var(p)=\frac{\alpha \times \beta}{(\alpha + beta)^2\times(\alpha + \beta + 1)}= \frac{6\times 36}{(6+36)^2\times(6+36+1)}=\)</span> 0.0028477. The posterior mode is <span class="math inline">\(MAP=\frac{\alpha-1}{\alpha + \beta - 2}=\)</span> 0.125.</p>
</section>
<section id="nutrition-example" class="level5">
<h5 class="anchored" data-anchor-id="nutrition-example">Nutrition Example</h5>
<p>You are studying a rare adverse event from a new dietary supplement. From prior literature, events are uncommon, but not impossible. You now run a small pilot study. You observe 7 adverse events out of 50 participants.</p>
<p>I think a reasonable prior probability for adverse events would be something like 1% with reasonable certainty (perhaps 1000 prior data points with 10 being affected, so <span class="math inline">\(\alpha=\text{successes}+1=11\)</span> 990 being unaffected so <span class="math inline">\(\beta=\text{failures}+1=991\)</span>), so i think a prior distribution of <span class="math inline">\(Beta(11,991)\)</span> makes sense.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>observed <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>tested <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> <span class="dv">18</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="dv">1037</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>By this logic, the posterior probability should be <span class="math inline">\(Beta(\alpha+y_o,beta+n-y_o)\)</span> or <span class="math inline">\(Beta(18,1037)\)</span>. This computes to a posterior mean of 0.0170616 [0.010152, 0.0256989] in comparison to an observed maximum likelihood estimator (MLE) of 0.14. The modal observation is <span class="math inline">\(MAP=\frac{\alpha-1}{\alpha + \beta - 2}=\)</span> or 0.0161443 with a variance of <span class="math inline">\(\frac{\alpha \times \beta}{(\alpha + beta)^2\times(\alpha + \beta + 1)}\)</span> or 1.5881167^{-5}. This is visualized below, illustrating the effect of a strong prior</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">probability=</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="at">by=</span><span class="fl">0.01</span>)) <span class="sc">|&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prior =</span> <span class="fu">dbeta</span>(probability,<span class="dv">11</span>,<span class="dv">991</span>),</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">posterior =</span> <span class="fu">dbeta</span>(probability,<span class="dv">18</span>,<span class="dv">1037</span>)) <span class="sc">|&gt;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">c</span>(prior,posterior),<span class="at">names_to=</span><span class="st">"type"</span>,<span class="at">values_to =</span> <span class="st">"density"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y=</span>density,<span class="at">x=</span>probability,<span class="at">col=</span>type)) <span class="sc">+</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept=</span>observed<span class="sc">/</span>tested, <span class="at">lty=</span><span class="dv">2</span>, <span class="at">col=</span><span class="st">"grey"</span>) <span class="sc">+</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">geom  =</span> <span class="st">"text"</span>,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">x     =</span> observed<span class="sc">/</span>tested<span class="fl">+0.01</span>,           <span class="co"># ← your chosen x-position</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">y     =</span> <span class="dv">8</span>,            <span class="co"># ← your chosen y-position</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Observed"</span>,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="dv">0</span>,            <span class="co"># 0 = left justified (most important part)</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">vjust =</span> <span class="fl">0.5</span>,          <span class="co"># optional: 0.5 = vertically centered</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">size  =</span> <span class="dv">5</span>, <span class="at">color =</span> <span class="st">"grey"</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>(<span class="at">base_size=</span><span class="dv">16</span>) <span class="sc">+</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="fu">c</span>(<span class="fl">0.8</span>,<span class="fl">0.8</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Bayesian-Learning-Notes_files/figure-html/second-beta-example-prior-posterior-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="proper-and-improper-distributions" class="level5">
<h5 class="anchored" data-anchor-id="proper-and-improper-distributions">Proper and Improper Distributions</h5>
<p>A <strong>proper probability distribution</strong> integrates to 1, this means if you add up the sum of all possible outcomes, you get unity. Bayes theorom assumes proper posterior probability distributions. This means that for discrete distributions like the bimomal <span class="math inline">\(\sum \text{probabilities}=1\)</span> and for continuous distributions <span class="math inline">\(\int \text{density}=1\)</span> (discreted distributions give exact probabilities for a number whereas continuous distributions give density between specific ranges).</p>
</section>
</section>
<section id="continuous-distributions" class="level4">
<h4 class="anchored" data-anchor-id="continuous-distributions">Continuous Distributions</h4>
<p>The <strong>central limit theorem</strong> justifies using a normal distribution for many casses. This means that for a binomial distribution for example, that as n becomes large, the binomial distribution becomes a normal distribution. The CLT says that averages and estimators can become normal even if the underlying data (<em>e.g.</em> binomal, bernoulli, poisson) is not.</p>
<p>For a normal distribution <span class="math inline">\(N(\mu, \sigma^2)\)</span> where <span class="math inline">\(\mu\)</span> is the mean and <span class="math inline">\(\sigma^2\)</span> is the variance (or the <span class="math inline">\(SE^2\)</span>).</p>
<section id="specifying-a-prior-for-the-standard-error-from-the-conjugate-prior-of-the-normal-distribution" class="level5">
<h5 class="anchored" data-anchor-id="specifying-a-prior-for-the-standard-error-from-the-conjugate-prior-of-the-normal-distribution">Specifying a Prior for the Standard Error From the Conjugate Prior of the Normal Distribution</h5>
<p>For a Normal likelihood with known mean <span class="math inline">\(\mu\)</span>, the conjugate prior for the variance is the inverse-gamma distribution: <span class="math inline">\(\sigma^2 \sim InvGamma(\alpha,\beta)\)</span> where <span class="math inline">\(\alpha\)</span> is the strength of the prior, approximately <span class="math inline">\(\alpha \approx \frac{df_{prior}}{2}\)</span> and <span class="math inline">\(\beta\)</span> is the prior scale, or approximately <span class="math inline">\(\beta \approx \frac{df_{prior} \times s^2_0}{2}\)</span> where <span class="math inline">\(s^2_0\)</span> is the prior guess of the variance. Key equations:</p>
<ul>
<li>For the variance <span class="math inline">\(E(\sigma^2)=\frac{\beta}{\alpha-1}\)</span> and <span class="math inline">\(Var(\sigma^2)=\frac{\beta^2}{(\alpha-1)^2(\alpha-2)}\)</span></li>
<li>The posterior mode is <span class="math inline">\(\frac{\beta}{\alpha+1}\)</span>.</li>
<li>With posterior updating (given a new degree of freedom <span class="math inline">\(\frac{n}{2}\)</span> and sum of squares <span class="math inline">\(\frac{S}{2}\)</span>), <span class="math inline">\(\sigma^2|y \sim InvGamma(\alpha + \frac{n}{2},\beta + \frac{S}{2})\)</span></li>
</ul>
<p>If we use precision <span class="math inline">\(\frac{1}{\sigma^2}\)</span> then the conjugate prior for variance is the Gamma distribution with the same meaning for <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> except that <span class="math inline">\(\beta\)</span> is now a rate rather than a scale.</p>
</section>
<section id="example-for-estimating-prior-and-posterior-variance" class="level5">
<h5 class="anchored" data-anchor-id="example-for-estimating-prior-and-posterior-variance">Example for Estimating Prior and Posterior Variance</h5>
<p>You are studying a biomarker that is known (from calibration experiments) to have mean <span class="math inline">\(\mu=100\)</span>. You are uncertain about the variance <span class="math inline">\(\sigma^2\)</span>. You have this prior information:</p>
<ul>
<li>From historical data, you believe that the standard deviation is around 5 units (so <span class="math inline">\(\sigma^2=25\)</span>)</li>
<li>This belief is roughly equivalent to 20 prior observations</li>
</ul>
<p>Based on this <span class="math inline">\(\alpha\)</span> should be approximately <span class="math inline">\(\frac{20}{2}=10\)</span> and <span class="math inline">\(\beta\)</span> should be approximately <span class="math inline">\(\beta \approx \frac{df_{prior} \times s^2_0}{2} = \frac{20 \times 5^2}{2}=250\)</span>. Therefore the prior for the variance should be described as <span class="math inline">\(\sigma^2 \sim InvGamma(10,250)\)</span>. This gives a prior mean of <span class="math inline">\(E(\sigma^2)=\frac{\beta}{\alpha-1}=\frac{250}{10-1}=\)</span> 27.7777778 with a variance of 96.4506173.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>new.values <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">101</span>,<span class="dv">96</span>,<span class="dv">98</span>,<span class="dv">103</span>,<span class="dv">99</span>,<span class="dv">100</span>,<span class="dv">97</span>,<span class="dv">102</span>,<span class="dv">104</span>,<span class="dv">95</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>You now collect 10 new measurements 101, 96, 98, 103, 99, 100, 97, 102, 104, 95. The sum of squares of these new values is 85. The posterior distribution of <span class="math inline">\(\sigma^2\)</span> is therefore</p>
<p><span class="math display">\[\sigma^2|y \sim InvGamma(\alpha + \frac{n}{2},\beta + \frac{S}{2})\]</span></p>
<p><span class="math display">\[ \sigma^2|y \sim InvGamma(10+\frac{10}{2},250+\frac{85}{2})=InvGamma(15,292.5)\]</span></p>
<p>This is visualized as</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>alpha_prior <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>beta_prior <span class="ot">&lt;-</span> <span class="dv">250</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>alpha_posterior <span class="ot">&lt;-</span> alpha_prior <span class="sc">+</span> <span class="fu">length</span>(new.values)<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>beta_posterior <span class="ot">&lt;-</span> beta_prior <span class="sc">+</span> <span class="fu">sum</span>((new.values<span class="dv">-100</span>)<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(invgamma)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">variance=</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">100</span>,<span class="at">by=</span><span class="dv">1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prior=</span><span class="fu">dinvgamma</span>(variance,alpha_prior,beta_prior),</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">posterior =</span> <span class="fu">dinvgamma</span>(variance,alpha_posterior,beta_posterior)) <span class="sc">|&gt;</span> </span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">c</span>(prior,posterior),</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"Distribution"</span>,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"density"</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y=</span>density,<span class="at">x=</span>variance,<span class="at">col=</span>Distribution)) <span class="sc">+</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="dv">25</span>, <span class="at">lty=</span><span class="dv">2</span>, <span class="at">col=</span><span class="st">"grey"</span>) <span class="sc">+</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">geom  =</span> <span class="st">"text"</span>,</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">x     =</span> <span class="dv">25</span><span class="sc">+</span><span class="dv">1</span>,           <span class="co"># ← your chosen x-position</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">y     =</span> <span class="fl">0.07</span>,            <span class="co"># ← your chosen y-position</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"Initial Estimate"</span>,</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="dv">0</span>,            <span class="co"># 0 = left justified (most important part)</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">vjust =</span> <span class="fl">0.5</span>,          <span class="co"># optional: 0.5 = vertically centered</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">size  =</span> <span class="dv">5</span>, <span class="at">color =</span> <span class="st">"grey"</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>(<span class="at">base_size =</span> <span class="dv">16</span>) <span class="sc">+</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="fu">c</span>(<span class="fl">0.8</span>,<span class="fl">0.8</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Bayesian-Learning-Notes_files/figure-html/continuous-prior-example-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The updated <span class="math inline">\(\sigma^2\)</span> values are then <span class="math inline">\(E(\sigma^2)=\frac{\beta}{\alpha-1}\)</span>, <span class="math inline">\(Var(\sigma^2)=\frac{\beta^2}{(\alpha-1)^2(\alpha-2)}\)</span>, and <span class="math inline">\(\text{Mode}=\frac{\beta}{\alpha+1}\)</span> so 20.8928571 [12.4523081, 34.8405654] with a modal value of 18.28125. This is compared to the prior estimates which were 27.7777778 [14.6328871, 52.1334173] and a modal value of 22.7272727. As you can see from the figure the posterior shifted left with the updated data that had smaller variance than expected. The updated standard deviation is 4.5708705[3.5287828, 5.9025897] compared to 5. The probability that the value is below 5 is 0.7984651. Note for this case we have to use Gamma rather than Inverse-Gamma due to point arithmetic issues with large arguments in <code>pinvgamma</code>.</p>
</section>
</section>
</section>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-CancerStatisticsNCI2015" class="csl-entry" role="listitem">
<span>“Cancer <span>Statistics</span> - <span>NCI</span>.”</span> 2015. {{cgvArticle}}. https://www.cancer.gov/about-cancer/understanding/statistics.
</div>
</div>
</section>
<section id="session-information" class="level2">
<h2 class="anchored" data-anchor-id="session-information">Session Information</h2>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.5.2 (2025-10-31)
Platform: aarch64-apple-darwin20
Running under: macOS Tahoe 26.2

Matrix products: default
BLAS:   /System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libBLAS.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/Detroit
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] invgamma_1.2    knitr_1.50      lubridate_1.9.4 forcats_1.0.1  
 [5] stringr_1.6.0   dplyr_1.1.4     purrr_1.2.0     readr_2.1.6    
 [9] tidyr_1.3.1     tibble_3.3.0    ggplot2_4.0.1   tidyverse_2.0.0

loaded via a namespace (and not attached):
 [1] gtable_0.3.6       jsonlite_2.0.0     compiler_4.5.2     tidyselect_1.2.1  
 [5] dichromat_2.0-0.1  scales_1.4.0       yaml_2.3.12        fastmap_1.2.0     
 [9] R6_2.6.1           labeling_0.4.3     generics_0.1.4     htmlwidgets_1.6.4 
[13] pillar_1.11.1      RColorBrewer_1.1-3 tzdb_0.5.0         rlang_1.1.6       
[17] stringi_1.8.7      xfun_0.54          S7_0.2.1           timechange_0.3.0  
[21] cli_3.6.5          withr_3.0.2        magrittr_2.0.4     digest_0.6.39     
[25] grid_4.5.2         rstudioapi_0.17.1  hms_1.1.4          lifecycle_1.0.4   
[29] vctrs_0.6.5        evaluate_1.0.5     glue_1.8.0         farver_2.1.2      
[33] rmarkdown_2.30     tools_4.5.2        pkgconfig_2.0.3    htmltools_0.5.9   </code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>